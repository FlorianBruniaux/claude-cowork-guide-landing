/**
 * Build script: Parse reference.yaml → generate src/data/guide-search-entries.ts
 * Run: node scripts/build-guide-index.mjs
 */

import { readFileSync, writeFileSync } from 'fs'
import { resolve, dirname } from 'path'
import { fileURLToPath } from 'url'
import yaml from 'js-yaml'

const __dirname = dirname(fileURLToPath(import.meta.url))
const ROOT = resolve(__dirname, '..')
const GUIDE_REPO = '/Users/florianbruniaux/Sites/perso/claude-cowork-guide'
const YAML_PATH = resolve(GUIDE_REPO, 'machine-readable/reference.yaml')
const OUT_PATH = resolve(ROOT, 'src/data/guide-search-entries.ts')
const GITHUB_BASE = 'https://github.com/FlorianBruniaux/claude-cowork-guide/blob/main/'

// Sections to index (key → path string mappings only)
const SECTIONS_TO_INDEX = ['docs', 'prompts', 'workflows']

/**
 * Convert snake_case key to Title Case human label
 * e.g. getting_started → "Getting Started", file_ops → "File Ops"
 */
function humanize(key) {
  const acronyms = new Set(['faq', 'ocr', 'api', 'ctoc', 'vpn', 'pdf', 'url'])
  return key
    .split('_')
    .map(word => acronyms.has(word.toLowerCase()) ? word.toUpperCase() : word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ')
}

/**
 * Derive category from the section name and file path
 */
function getCategory(section, path) {
  if (section === 'docs') {
    if (path.includes('reference/')) return 'Reference'
    return 'Guide'
  }
  if (section === 'prompts') return 'Prompts'
  if (section === 'workflows') return 'Workflows'
  return 'Guide'
}

/**
 * Strip the leading "cowork/" prefix from paths
 * (reference.yaml uses legacy paths from when cowork was a subfolder)
 * e.g. "cowork/guide/01-quick-start.md" → "guide/01-quick-start.md"
 */
function stripCoworkPrefix(path) {
  return path.startsWith('cowork/') ? path.slice(7) : path
}

/**
 * Strip :lineNumber suffix from a path
 * e.g. "guide/architecture.md:272" → "guide/architecture.md"
 */
function stripLineNumber(path) {
  return path.replace(/:\d+$/, '')
}

/**
 * Extract keywords from section, key and path
 */
function extractKeywords(section, key, path) {
  const keyWords = key.split('_').join(' ')
  const sectionWord = section === 'docs' ? 'guide documentation' : section
  const pathWords = path.split(/[/_.-]/).filter(w => w.length > 2 && !['md', 'sh', 'yaml', 'json', 'ts'].includes(w)).join(' ')
  return `${keyWords} ${sectionWord} ${pathWords}`.toLowerCase().trim()
}

function main() {
  let raw
  try {
    raw = readFileSync(YAML_PATH, 'utf-8')
  } catch (err) {
    console.warn(`[build-guide-index] WARNING: Could not read ${YAML_PATH}`)
    console.warn(`[build-guide-index] Generating empty guide-search-entries.ts`)
    writeEmpty()
    return
  }

  let parsed
  try {
    parsed = yaml.load(raw)
  } catch (err) {
    console.error(`[build-guide-index] ERROR: Failed to parse YAML: ${err.message}`)
    writeEmpty()
    return
  }

  const entriesEN = []
  const entriesFR = []
  const seen = new Set()

  for (const section of SECTIONS_TO_INDEX) {
    const sectionData = parsed?.[section]
    if (!sectionData || typeof sectionData !== 'object') {
      console.warn(`[build-guide-index] WARNING: Section "${section}" not found in YAML`)
      continue
    }

    for (const [key, value] of Object.entries(sectionData)) {
      if (typeof value !== 'string') continue
      if (!value.includes('.md') && !value.includes('/')) continue

      const rawPath = stripLineNumber(value)
      const cleanPath = stripCoworkPrefix(rawPath)

      if (seen.has(cleanPath)) continue
      seen.add(cleanPath)

      const id = `guide-${section}-${key.replace(/_/g, '-')}`
      const titleEN = humanize(key)
      const category = getCategory(section, cleanPath)
      const url = `${GITHUB_BASE}${cleanPath}`
      const keywordsEN = extractKeywords(section, key, cleanPath)

      entriesEN.push({ id, title: titleEN, keywords: keywordsEN, category, url, source: 'guide' })

      // French variant: same URL, French category labels
      const categoryFR = category === 'Guide' ? 'Guide' : category === 'Prompts' ? 'Prompts' : category === 'Workflows' ? 'Workflows' : 'Référence'
      entriesFR.push({ id, title: titleEN, keywords: keywordsEN, category: categoryFR, url, source: 'guide' })
    }
  }

  console.log(`[build-guide-index] Generated ${entriesEN.length} guide entries (EN + FR)`)

  const content = generateTS(entriesEN, entriesFR)
  writeFileSync(OUT_PATH, content, 'utf-8')
  console.log(`[build-guide-index] Written to ${OUT_PATH}`)
}

function writeEmpty() {
  writeFileSync(OUT_PATH, generateTS([], []), 'utf-8')
}

function generateTS(entriesEN, entriesFR) {
  const jsonEN = JSON.stringify(entriesEN, null, 2)
  const jsonFR = JSON.stringify(entriesFR, null, 2)
  return `// Auto-generated by scripts/build-guide-index.mjs
// DO NOT EDIT MANUALLY - run: node scripts/build-guide-index.mjs

export interface GuideSearchEntry {
  id: string
  title: string
  keywords: string
  category: string
  url: string
  source: 'guide'
}

export const GUIDE_ENTRIES_EN: GuideSearchEntry[] = ${jsonEN}

export const GUIDE_ENTRIES_FR: GuideSearchEntry[] = ${jsonFR}
`
}

main()
